<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marina Page Builder</title>
    
    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Plyr (–ö—Ä–∞—Å–∏–≤—ã–π –ø–ª–µ–µ—Ä –¥–ª—è –∑–∞–º–µ–Ω—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ iOS) -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    
    <!-- LZ-String (–î–ª—è —Å–∂–∞—Ç–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Å—Å—ã–ª–∫—É) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Playfair+Display&family=Montserrat&display=swap" rel="stylesheet">

    <style>
        :root { --tg-theme-bg-color: #fff; --tg-theme-text-color: #000; --tg-theme-button-color: #3390ec; --tg-theme-button-text-color: #fff; }
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        #app { padding: 15px; max-width: 600px; margin: 0 auto; }

        /* –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
        .editor-controls { border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; }
        .btn { background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; padding: 10px 15px; border-radius: 8px; margin: 5px; cursor: pointer; font-size: 14px; }
        .btn-del { background: #ff3b30; }
        
        .block { position: relative; margin-bottom: 15px; border: 1px dashed #ccc; padding: 10px; border-radius: 8px; }
        .view-mode .block { border: none; padding: 0; }
        
        /* –≠–ª–µ–º–µ–Ω—Ç—ã */
        input, textarea, select { width: 100%; box-sizing: border-box; margin-top: 5px; padding: 8px; border-radius: 6px; border: 1px solid #ddd; }
        img { max-width: 100%; border-radius: 10px; }
        
        /* –®—Ä–∏—Ñ—Ç—ã */
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .font-montserrat { font-family: 'Montserrat', sans-serif; }

        /* –°—Ç–∏–ª–∏ –±–ª–æ–∫–æ–≤ */
        h2 { margin-top: 0; }
        .price-tag { font-size: 1.2em; font-weight: bold; color: #2ecc71; text-align: center; margin: 10px 0; }

        /* –°–∫—Ä—ã—Ç–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
        .hidden { display: none !important; }
        
        /* Plyr –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è */
        .plyr { border-radius: 12px; overflow: hidden; margin-top: 10px; }
    </style>
</head>
<body>

<div id="app">
    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –ú–∞—Ä–∏–Ω–µ) -->
    <div id="editor-panel" class="editor-controls hidden">
        <h3>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</h3>
        <button class="btn" onclick="addBlock('header')">+ –ó–∞–≥–æ–ª–æ–≤–æ–∫</button>
        <button class="btn" onclick="addBlock('text')">+ –¢–µ–∫—Å—Ç</button>
        <button class="btn" onclick="addBlock('image')">+ –§–æ—Ç–æ (URL)</button>
        <button class="btn" onclick="addBlock('video')">+ –í–∏–¥–µ–æ (Plyr)</button>
        <button class="btn" onclick="addBlock('price')">+ –¶–µ–Ω–∞</button>
        <hr>
        <label>–®—Ä–∏—Ñ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã:</label>
        <select id="font-selector" onchange="changeGlobalFont()">
            <option value="font-roboto">Roboto (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
            <option value="font-playfair">Playfair (–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π)</option>
            <option value="font-montserrat">Montserrat (–°—Ç—Ä–æ–≥–∏–π)</option>
        </select>
        <br><br>
        <button class="btn" style="width: 100%; font-weight: bold;" onclick="savePage()">üíæ –°–û–•–†–ê–ù–ò–¢–¨ –ò –ü–û–õ–£–ß–ò–¢–¨ –°–°–´–õ–ö–£</button>
    </div>

    <!-- –°—é–¥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –±–ª–æ–∫–∏ -->
    <div id="content-area"></div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL (–µ—Å–ª–∏ —ç—Ç–æ –∫–ª–∏–µ–Ω—Ç)
    const urlParams = new URLSearchParams(window.location.search);
    const compressedData = urlParams.get('data');

    let blocks = [];
    let globalFont = 'font-roboto';

    if (compressedData) {
        // --- –†–ï–ñ–ò–ú –ü–†–û–°–ú–û–¢–†–ê (–ö–õ–ò–ï–ù–¢) ---
        try {
            const json = LZString.decompressFromEncodedURIComponent(compressedData);
            const data = JSON.parse(json);
            blocks = data.blocks;
            globalFont = data.font || 'font-roboto';
            document.body.classList.add(globalFont);
            document.body.classList.add('view-mode');
            renderView();
        } catch (e) {
            alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏");
        }
    } else {
        // --- –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê (–ú–ê–†–ò–ù–ê) ---
        document.getElementById('editor-panel').classList.remove('hidden');
        tg.MainButton.setText("–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –≤ –±–æ—Ç–∞");
        tg.MainButton.onClick(() => savePage(true));
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞ (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞)
    function addBlock(type) {
        const blockId = Date.now();
        blocks.push({ id: blockId, type: type, content: '' });
        renderEditor();
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞
    function removeBlock(id) {
        blocks = blocks.filter(b => b.id !== id);
        renderEditor();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ –º–∞—Å—Å–∏–≤–µ
    function updateBlock(id, value) {
        const block = blocks.find(b => b.id === id);
        if (block) block.content = value;
    }

    // –†–µ–Ω–¥–µ—Ä —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ (–ø–æ–ª—è –≤–≤–æ–¥–∞)
    function renderEditor() {
        const container = document.getElementById('content-area');
        container.innerHTML = '';
        document.body.className = globalFont;

        blocks.forEach(block => {
            const div = document.createElement('div');
            div.className = 'block';
            
            let inputHtml = '';
            if (block.type === 'header') inputHtml = `<input type="text" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" oninput="updateBlock(${block.id}, this.value)" value="${block.content}">`;
            if (block.type === 'text') inputHtml = `<textarea rows="4" placeholder="–¢–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è" oninput="updateBlock(${block.id}, this.value)">${block.content}</textarea>`;
            if (block.type === 'image') inputHtml = `<input type="text" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (https://...)" oninput="updateBlock(${block.id}, this.value)" value="${block.content}"><br><small>–í—Å—Ç–∞–≤—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É</small>`;
            if (block.type === 'video') inputHtml = `<input type="text" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ (mp4/–ø—Ä—è–º–∞—è)" oninput="updateBlock(${block.id}, this.value)" value="${block.content}"><br><small>–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ MP4 —Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ –≤—Å–µ–≥–æ</small>`;
            if (block.type === 'price') inputHtml = `<input type="text" placeholder="–¶–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 5000 —Ä—É–±)" oninput="updateBlock(${block.id}, this.value)" value="${block.content}">`;

            div.innerHTML = `
                <strong>${block.type.toUpperCase()}</strong>
                <button class="btn btn-del" style="float:right; padding: 2px 8px;" onclick="removeBlock(${block.id})">X</button>
                ${inputHtml}
            `;
            container.appendChild(div);
        });
    }

    // –†–µ–Ω–¥–µ—Ä –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π –≤–∏–¥)
    function renderView() {
        const container = document.getElementById('content-area');
        container.innerHTML = '';

        blocks.forEach(block => {
            const div = document.createElement('div');
            div.style.marginBottom = "20px";
            
            if (block.type === 'header') {
                div.innerHTML = `<h2>${block.content}</h2>`;
            } else if (block.type === 'text') {
                div.innerHTML = `<p style="white-space: pre-wrap;">${block.content}</p>`;
            } else if (block.type === 'image') {
                div.innerHTML = `<img src="${block.content}" alt="Image">`;
            } else if (block.type === 'video') {
                // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–ª–µ–µ—Ä Plyr
                const videoId = `player-${block.id}`;
                div.innerHTML = `
                    <video id="${videoId}" playsinline controls>
                        <source src="${block.content}" type="video/mp4" />
                    </video>
                `;
                setTimeout(() => { new Plyr(`#${videoId}`); }, 100);
            } else if (block.type === 'price') {
                div.className = 'price-tag';
                div.innerText = block.content;
            }
            container.appendChild(div);
        });
    }

    function changeGlobalFont() {
        globalFont = document.getElementById('font-selector').value;
        document.body.className = globalFont;
    }

    function savePage(sendToBot = false) {
        const data = {
            blocks: blocks,
            font: globalFont
        };
        const json = JSON.stringify(data);
        const compressed = LZString.compressToEncodedURIComponent(json);
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∞–º—É —Å–µ–±—è —Å –¥–∞–Ω–Ω—ã–º–∏
        const baseUrl = window.location.href.split('?')[0];
        const fullUrl = `${baseUrl}?data=${compressed}`;

        if (sendToBot) {
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞ (–ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç)
            tg.sendData(fullUrl);
        } else {
            // –†—É—á–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
            navigator.clipboard.writeText(fullUrl).then(() => {
                alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—Å—Ç–∞–≤—å –µ—ë –≤ –±–æ—Ç–∞.");
            });
        }
    }
</script>

</body>
  </html>
